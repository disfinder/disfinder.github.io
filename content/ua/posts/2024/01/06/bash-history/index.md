---
title: "bash history: переписуємо історію"
date: 2024-01-06T22:30:53-05:00
# bookComments: false
# bookSearchExclude: false
tags:
    - bash
    - shell
    - history
    - awk
    - sponge
---

## Проблема із баш історією

Колись давно я вважав, що мати таймстемп для кожної виконаної команди у консолі то гарна ідея.
<!--more-->
Розробники башу вважали так само, тому за бажання це можна легко налаштувати:

Ось оця команда у профілі

```shell
export HISTTIMEFORMAT="[%F %T] "
```

змушує історію башу виглядати отак:

```shell
12715  [2024-01-06 22:24:48] gs
12716  [2024-01-06 22:24:50] git diff
12717  [2024-01-06 22:24:54] git add -u
12718  [2024-01-06 22:24:54] gs
12720  [2024-01-06 22:25:41] gs
12721  [2024-01-06 22:27:56] history
12722  [2024-01-06 22:28:16] history | wc -l
12723  [2024-01-06 22:28:24] history | head -10
12724  [2024-01-06 22:28:24] history | head -10
12725  [2024-01-06 22:28:38] history | head -10 | awk '{print $5}'
```

Однак виявилася невеличка проблема - всього записів у історії - 12к, тоді як унікальних лише ~5к, тобто оверхед ледве не втричі..

```shell
$ history | awk -F] '{print $2}' |  wc -l
   12741
$ history | awk -F] '{print $2}' | sort -u | wc -l
    4741
```

Виходить, включення таймстемпу приводить до того, що баш ігнорує (чи не може обробити нормально) налаштування

```shell
export HISTCONTROL=ignoreboth:erasedups
```

яке мало призвести до відсутності дублікатів в історії.

Робимо бекап і фіксимо.

## Робимо бекап

Позаяк [дотфайли в мене лежать в гіт-репозиторії](https://github.com/disfinder/pimp-my-mac/blob/master/playbook-init.yml#L155-L167), то забекапитися досить просто:

```shell
j dotfiles && git add .bash_history && git cm 'SAVE: before changing bash history'
```

## Фіксаємо

{{< hint info >}}
У мене профіль, як і багато іншого, менеджиться через [власноруч написану ансіблову плейбуку](https://github.com/disfinder/pimp-my-mac), тому конфіги я не редагую напряму, а редагую шаблони і вже потім оновлюю все ансіблом.
{{< /hint >}}

Коментуємо строчку із `export HISTTIMEFORMAT="[%F %T] "` у [шаблоні баш-профайлу](https://github.com/disfinder/pimp-my-mac/blob/master/bash/bash.bashrc)  

Ще нам знадобиться `sponge`, тому треба додати його до [списку brew-пакетів](https://github.com/disfinder/pimp-my-mac/blob/7ffd9faaa02a8f8c3bed4033e2f88c46c4259bb5/playbook-init.yml#L17)

Закриваємо всі сесії башу, запускаємо `zsh` і оновлюємо баш-профіль та пакети brew:
```shell
./playbook-init.yml --tags bash,brew
```

## Переписуємо стару історію


Після зроблених змін все рівно у поточному файлі історії залишаться таймстемпи. Щоб їх позбутися, нам і знадобиться `sponge` - без нього [складно писати в той самий файл, із якого ти читаєш](https://mywiki.wooledge.org/BashPitfalls#cat_file_.7C_sed_s.2Ffoo.2Fbar.2F_.3E_file).

```shell
cat ~/.bash_history | grep -v '#' | sort -u | sponge  ~/.bash_history
```

{{< hint warning >}}
Пропадуть також команди, в яких був символ `#`, це я вже зрозумів після - але заглянув у забекаплену версію, такі команди в мене були, але небагато і не являють "історичної" цінності, так що і нехай, ліньки переробляти.
{{< /hint >}}

## Перевіряємо

```shell
$ history | awk '{$1="";print $0}' | wc -l # надрукуй все крім першого поля
    4802

$ history | wc -l
    4802
```

Вуаля.
